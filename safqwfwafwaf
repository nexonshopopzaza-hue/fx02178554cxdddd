--========================================================
-- NEXON — Professional Mob Farm (lean edition)
--  - WORLD-AWARE: FARM world = ฟาร์ม, ORIGINS world = ขาย
--  - pause/resume ต่อเนื่อง
--  - ลูปเบาเครื่อง / ไม่สแปมทรัพยากร
--  - ✔ Autosell: Meat + Bacon
--========================================================

do
    if getgenv().__NEXON_FARM_LOADED then return end
    getgenv().__NEXON_FARM_LOADED = true

    -- ---------- CONFIG ----------
    local defaults = {
        ATTACKS_PER_TARGET = 6,
        ATTACK_INTERVAL    = 0.35,
        TELEPORT_DIST      = 12,
        TARGET_RECHECK     = 2.5,
        STUCK_SEC          = 3.0,

        serverHopWhenBusy  = true,
        checkEmptyServers  = true,
        performanceBoost   = true,
        antiAFK            = true,
        keepDragonFloat    = true,
        autoSell           = true,

        targetResources = { Bacon=100, Meat=100, Ashes=0, Fossil=0 },
        priorityMobs    = { "Dimorph","Ptero","Stego" },
        mobNames        = { "Dimorph","Ptero","Stego" },
    }
    local CFG = setmetatable(getgenv().AutoFarmConfig or {}, { __index = defaults })
    -- compat keys (ตาม config ที่คุณใช้)
    CFG.TELEPORT_DIST  = CFG.TELEPORT_DIST  or CFG.TELEPORT_DISTANCE_THRESHOLD
    CFG.TARGET_RECHECK = CFG.TARGET_RECHECK or CFG.TARGET_RECHECK_DELAY
    CFG.performanceBoost = (CFG.performanceBoost ~= nil and CFG.performanceBoost) or CFG.enablePerformanceOptimization
    CFG.autoSell = (CFG.autoSell ~= nil and CFG.autoSell) or CFG.autoSellEnabled
    CFG.antiAFK  = (CFG.antiAFK  ~= nil and CFG.antiAFK ) or CFG.antiAfkEnabled

    -- ---------- SERVICES ----------
    local Players = game:GetService("Players")
    local Player  = Players.LocalPlayer
    local RS      = game:GetService("RunService")
    local VIM     = game:GetService("VirtualInputManager")
    local Rep     = game:GetService("ReplicatedStorage")
    local UIS     = game:GetService("UserInputService")
    local Http    = game:GetService("HttpService")
    local TP      = game:GetService("TeleportService")

    -- ---------- CONSTANTS ----------
    local WORLD_FARM    = 4869039553   -- Prehistoric
    local WORLD_ORIGINS = 3475397644   -- Origins
    local OTHER_WORLDS  = {
        4601778915, 3475419198, 3475422608, 3487210751,
        3623549100, 3737848045, 3752680052, 4174118306, 4728805070
    }
    if CFG.teleportWorlds then
        local t = {}
        for _, id in pairs(CFG.teleportWorlds) do table.insert(t, id) end
        OTHER_WORLDS  = t
        WORLD_FARM    = CFG.teleportWorlds["Prehistoric"] or WORLD_FARM
        WORLD_ORIGINS = CFG.teleportWorlds["Origins"]     or WORLD_ORIGINS
    end

    local PRIORITY_MOBS = CFG.priorityMobs
    local MOB_NAMES     = CFG.mobNames
    local GOALS         = CFG.targetResources

    local function try(fn, ...) local ok,res=pcall(fn, ...); if ok then return res end end

    -- ---------- LIGHT CLEANUP ----------
    task.spawn(function()
        try(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/SDsfwqq/Auto-Mob/main/config.lua"))() end)
        try(function() local R=Rep:FindFirstChild("Remotes"); local t=R and R:FindFirstChild("MobDamageRemote"); if t then t:Destroy() end end)
        try(function() local pg=Player:WaitForChild("PlayerGui",5); local g=pg and pg:FindFirstChild("WorkspaceGui"); if g then g:Destroy() end end)
    end)

    -- ---------- PERFORMANCE ----------
    local function applyPerformance()
        if not CFG.performanceBoost then return end
        task.spawn(function()
            try(function()
                local L=game:GetService("Lighting")
                for _,v in ipairs(L:GetChildren()) do if not v:IsA("Sky") then v:Destroy() end end
                L.GlobalShadows=false; L.FogEnd=1e9; L.Brightness=0; L.ClockTime=14
            end)
            try(function()
                for _,o in ipairs(workspace:GetDescendants()) do
                    if o:IsA("BasePart") then o.Material=Enum.Material.SmoothPlastic; o.Reflectance=0; o.CastShadow=false
                    elseif o:IsA("Decal") or o:IsA("Texture") then o.Transparency=1
                    elseif o:IsA("ParticleEmitter") or o:IsA("Trail") or o:IsA("Beam") then o.Enabled=false
                    elseif o:IsA("Light") then o.Enabled=false end
                end
            end)
            try(function()
                settings().Rendering.QualityLevel=Enum.QualityLevel.Level01
                settings().Rendering.MeshPartDetailLevel=Enum.MeshPartDetailLevel.Level02
            end)
        end)
    end
    applyPerformance()

    -- ---------- STATE ----------
    local S = {
        enabled = false,
        target  = nil,
        lastHP  = nil,
        stuckAt = 0,
        lastAttackAt  = 0,
        lastSwitchAt  = 0,
        farmConn = nil,

        teleportedToSell = false,   -- true เมื่อจากฟาร์มครบเป้าหมายแล้วเทเลไปขาย
        nextSellAt = 0,             -- throttle การยิงรีโมทขาย
    }

    -- ---------- DRAGON ----------
    local function getChar() return Player.Character or Player.CharacterAdded:Wait() end
    local function getMountedDragon()
        local c=getChar(); local ds=c:FindFirstChild("Dragons"); if not ds then return end
        local hum=c:FindFirstChildOfClass("Humanoid")
        for _,d in ipairs(ds:GetChildren()) do
            local seat=d:FindFirstChildWhichIsA("VehicleSeat") or d:FindFirstChild("Seat")
            if seat and seat.Occupant==hum then return d end
        end
    end
    local function breathRemote(dragon)
        local rem=dragon and dragon:FindFirstChild("Remotes")
        return rem and (rem:FindFirstChild("PlaySoundRemote") or rem:FindFirstChild("BreathFireRemote"))
    end

    -- ---------- TARGET ----------
    local function mobFolderGlobal()
        local n=workspace:FindFirstChild("Interactions")
        n=n and n:FindFirstChild("Nodes")
        n=n and n:FindFirstChild("Mobs")
        n=n and n:FindFirstChild("ActiveMobs")
        n=n and n:FindFirstChild("Global")
        return n
    end
    local function findTarget()
        local g=mobFolderGlobal()
        if g then
            for _,name in ipairs(PRIORITY_MOBS) do
                local m=g:FindFirstChild(name)
                if m and m:FindFirstChild("Health") and m.Health.Value>0 then return m end
            end
        end
        local f=workspace:FindFirstChild("MobFolder")
        if f then
            for _,wrap in ipairs(f:GetChildren()) do
                for _,name in ipairs(MOB_NAMES) do
                    local m=wrap:FindFirstChild(name)
                    if m and m:FindFirstChild("Health") and m.Health.Value>0 then return m end
                end
            end
        end
    end

    local function partPos(model)
        if model:IsA("BasePart") then return model.Position end
        if model.PrimaryPart then return model.PrimaryPart.Position end
        local p=model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
        return p and p.Position or nil
    end
    local function teleportNear(target)
        local pos=partPos(target); local me=getChar().PrimaryPart
        if not(pos and me) then return end
        local dist=(me.Position-pos).Magnitude
        if dist>(CFG.TELEPORT_DIST or defaults.TELEPORT_DIST) then
            local a=math.rad(math.random(0,359))
            local off=Vector3.new(math.cos(a),0,math.sin(a))*15
            try(function() getChar():SetPrimaryPartCFrame(CFrame.new(pos+off+Vector3.new(0,5,0))) end)
        end
    end
    local function keepDragonFloating()
        if not CFG.keepDragonFloat then return end
        local d=getMountedDragon()
        if d and d.PrimaryPart then
            local p=d.PrimaryPart.Position
            try(function() d:SetPrimaryPartCFrame(CFrame.new(p.X,p.Y+5,p.Z)) end)
        end
    end

    -- ---------- COMBAT ----------
    local function hyperAttack(target, dragon)
        local rem=breathRemote(dragon); if not rem then return end
        for i=1,(CFG.ATTACKS_PER_TARGET or defaults.ATTACKS_PER_TARGET) do
            if not(S.enabled and target and target.Parent) then break end
            local hp=target:FindFirstChild("Health"); if not(hp and hp.Value>0) then break end
            try(function() rem:FireServer("Breath","Mobs",target) end)
            task.wait(CFG.ATTACK_INTERVAL or defaults.ATTACK_INTERVAL)
        end
    end
    local function biteAndBreath()
        local d=getMountedDragon(); if not d then return end
        local breath=d:FindFirstChild("Remotes") and d.Remotes:FindFirstChild("BreathFireRemote")
        if breath then try(function() breath:FireServer(true) end) end
        VIM:SendKeyEvent(true, Enum.KeyCode.F, false, game); task.wait(0.05)
        VIM:SendKeyEvent(false,Enum.KeyCode.F, false, game)
    end

    -- ---------- RESOURCES / SELL ----------
    local function resources()
        local d=Player:FindFirstChild("Data"); return d and d:FindFirstChild("Resources")
    end
    local function reachedGoals()
        local res=resources(); if not res then return false end
        for name,goal in pairs(GOALS) do
            local v=(res:FindFirstChild(name) and res[name].Value) or 0
            if v<goal then return false end
        end
        return true
    end
    local function hasSellableMeatBacon()
        local res=resources(); if not res then return false end
        local m=res:FindFirstChild("Meat");  local b=res:FindFirstChild("Bacon")
        return ((m and m.Value or 0)>0) or ((b and b.Value or 0)>0)
    end
    local function sellMeatAndBacon()
        local res=resources(); if not res then return end
        local sellRemote = Rep:WaitForChild("Remotes"):WaitForChild("SellItemRemote")

        local function sellOne(name)
            local node = res:FindFirstChild(name)
            local amt  = node and node.Value or 0
            if amt > 0 then
                -- NOTE: ตามสเปคของคุณ → FireServer({ ItemName=..., Amount=... })
                try(function() sellRemote:FireServer({ ItemName = name, Amount = amt }) end)
                task.wait(0.2)
            end
        end
        sellOne("Meat")
        sellOne("Bacon")
    end

    -- ---------- SERVER HOP ----------
    local function httpRequestAvailable() return (syn and syn.request) or request or http_request end
    local function getEmptyServerPlaceId(placeId)
        if not (CFG.checkEmptyServers and httpRequestAvailable()) then return nil end
        local req=(syn and syn.request) or request or http_request
        local url=("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(placeId)
        local res=try(req,{Url=url,Method="GET"})
        if res and res.StatusCode==200 then
            local data=try(Http.JSONDecode,Http,res.Body)
            if data and data.data then for _,s in ipairs(data.data) do if s.playing<=1 then return placeId end end end
        end
        return nil
    end
    local function hopToRandomWorld()
        local id=OTHER_WORLDS[math.random(1,#OTHER_WORLDS)]
        local tele=Rep:FindFirstChild("Remotes") and Rep.Remotes:FindFirstChild("WorldTeleportRemote")
        if tele then try(tele.InvokeServer,tele,id,{}) end
    end
    local function hopToEmptyWorldFromList()
        for _,id in ipairs(OTHER_WORLDS) do
            local okId=getEmptyServerPlaceId(id)
            if okId then local tele=Rep.Remotes:FindFirstChild("WorldTeleportRemote"); if tele then try(tele.InvokeServer,tele,okId,{}) end; return true end
        end
        hopToRandomWorld(); return true
    end

    -- ---------- HEARTBEAT (แยกตามโลกชัดเจน) ----------
    local function ensureTarget(now)
        local recheck=(CFG.TARGET_RECHECK or defaults.TARGET_RECHECK)
        if now - S.lastSwitchAt > recheck
            or (not S.target)
            or (S.target:FindFirstChild("Health") and S.target.Health.Value<=0) then
            S.target=findTarget(); S.lastSwitchAt=now; S.lastHP=nil; S.stuckAt=now
        end
    end

    local function farmTick(now)
        -- world: FARM เท่านั้น
        if CFG.serverHopWhenBusy and #Players:GetPlayers()>1 then
            hopToEmptyWorldFromList(); return
        end

        -- ถึงเป้าหมาย → เทเลไปขาย
        if CFG.autoSell and reachedGoals() and not S.teleportedToSell then
            S.teleportedToSell = true
            local tele = Rep.Remotes:FindFirstChild("WorldTeleportRemote")
            if tele then try(tele.InvokeServer, tele, WORLD_ORIGINS, {}) end
            return
        end

        local dragon=getMountedDragon(); if not dragon then return end
        ensureTarget(now); if not S.target then return end

        teleportNear(S.target)
        if CFG.keepDragonFloat then keepDragonFloating() end

        local hp = S.target:FindFirstChild("Health") and S.target.Health.Value or 0
        if S.lastHP == nil then
            S.lastHP = hp; S.stuckAt = now
        elseif hp >= S.lastHP then
            if now - S.stuckAt > (CFG.STUCK_SEC or defaults.STUCK_SEC) then
                try(TP.Teleport, TP, game.PlaceId, Player); return
            end
        else
            S.lastHP = hp; S.stuckAt = now
        end

        local interval = (CFG.ATTACK_INTERVAL or defaults.ATTACK_INTERVAL)
        local perRound = (CFG.ATTACKS_PER_TARGET or defaults.ATTACKS_PER_TARGET)
        if now - S.lastAttackAt > (interval * perRound) then
            hyperAttack(S.target, dragon)
            biteAndBreath()
            S.lastAttackAt = now
        end
    end

    local function sellTick(now)
        -- world: ORIGINS เท่านั้น
        -- throttle ขายทุก ~0.5s
        if now >= S.nextSellAt then
            if hasSellableMeatBacon() then
                sellMeatAndBacon()
                S.nextSellAt = now + 0.6
                return
            end
        end
        -- ไม่มีอะไรขายแล้ว → กลับฟาร์ม & รีเซ็ตสถานะขาย
        local tele=Rep.Remotes:FindFirstChild("WorldTeleportRemote")
        if tele then try(tele.InvokeServer, tele, WORLD_FARM, {}) end
        S.teleportedToSell = false
    end

    local function runOncePerHeartbeat()
        if not S.enabled then return end
        local now = tick()
        local place = game.PlaceId

        if place == WORLD_FARM then
            farmTick(now)
        elseif place == WORLD_ORIGINS then
            sellTick(now)
        else
            -- อยู่นอก 2 โลก → ดึงกลับฟาร์มอย่างสุภาพ
            local tele=Rep.Remotes:FindFirstChild("WorldTeleportRemote")
            if tele then try(tele.InvokeServer, tele, WORLD_FARM, {}) end
        end
    end

    -- ---------- START/STOP ----------
    local function startLoop()
        if S.farmConn then return end
        S.farmConn = RS.Heartbeat:Connect(runOncePerHeartbeat)
    end
    local function stopLoop()
        if S.farmConn then S.farmConn:Disconnect(); S.farmConn=nil end
    end

    -- ---------- MINIMAL UI ----------
    local function makeUI()
        local gui = Instance.new("ScreenGui")
        gui.Name = "NEXON_FarmUI_Lean"
        gui.ResetOnSpawn = false
        gui.Parent = game.CoreGui

        local frame = Instance.new("Frame", gui)
        frame.Size = UDim2.fromOffset(240, 86)
        frame.Position = UDim2.new(0, 20, 0, 200)
        frame.BackgroundColor3 = Color3.fromRGB(28,28,38)
        frame.BorderSizePixel = 0
        Instance.new("UICorner", frame).CornerRadius = UDim.new(0,8)

        local title = Instance.new("TextLabel", frame)
        title.Size = UDim2.new(1,-10,0,24)
        title.Position = UDim2.new(0,10,0,8)
        title.BackgroundTransparency = 1
        title.Font = Enum.Font.GothamBold
        title.TextSize = 14
        title.TextColor3 = Color3.fromRGB(180,220,255)
        title.TextXAlignment = Enum.TextXAlignment.Left
        title.Text = "NEXON — Mob Farm"

        local status = Instance.new("TextLabel", frame)
        status.Size = UDim2.new(1,-10,0,20)
        status.Position = UDim2.new(0,10,0,32)
        status.BackgroundTransparency = 1
        status.Font = Enum.Font.Gotham
        status.TextSize = 13
        status.TextXAlignment = Enum.TextXAlignment.Left
        status.TextColor3 = Color3.fromRGB(255,120,120)
        status.Text = "Stopped"

        local btn = Instance.new("TextButton", frame)
        btn.Size = UDim2.new(0,100,0,30)
        btn.Position = UDim2.new(1,-110,1,-38)
        btn.BackgroundColor3 = Color3.fromRGB(60,180,60)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.TextSize = 14
        btn.Font = Enum.Font.GothamBold
        btn.Text = "START"
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

        local function refresh()
            if S.enabled then
                btn.Text = "STOP"
                btn.BackgroundColor3 = Color3.fromRGB(200,60,60)
                status.Text = "Running"
                status.TextColor3 = Color3.fromRGB(120,255,120)
            else
                btn.Text = "START"
                btn.BackgroundColor3 = Color3.fromRGB(60,180,60)
                status.Text = "Stopped"
                status.TextColor3 = Color3.fromRGB(255,120,120)
            end
        end

        btn.MouseButton1Click:Connect(function()
            S.enabled = not S.enabled
            if S.enabled then startLoop() else stopLoop() end
            refresh()
        end)

        UIS.InputBegan:Connect(function(inp,gp)
            if gp then return end
            if inp.KeyCode == Enum.KeyCode.RightControl then
                gui.Enabled = not gui.Enabled
            end
        end)

        refresh()
        return gui
    end

    -- ---------- ANTI-AFK ----------
    if CFG.antiAFK then
        task.spawn(function()
            while true do
                task.wait(60)
                VIM:SendMouseButtonEvent(0,0,1,true,nil,0)
                VIM:SendMouseMoveEvent(3,0,0,false)
                VIM:SendMouseButtonEvent(0,0,1,false,nil,0)
            end
        end)
    end

    -- ---------- BOOT ----------
    local _ui = makeUI()
    S.enabled = true
    startLoop()
end
